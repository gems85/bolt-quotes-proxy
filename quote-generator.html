<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bolt Quotes - Quote Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .project-selector {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .project-selector label {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .project-selector select {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.95rem;
        }
        
        .refresh-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95rem;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .left-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }
        
        .info-row {
            display: flex;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 600;
            color: #555;
            min-width: 100px;
        }
        
        .info-value {
            color: #333;
            flex: 1;
        }
        
        .status-select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .photos-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .photo-card {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
            background: #f9f9f9;
        }
        
        .photo-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        
        .photo-label {
            padding: 8px;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 600;
            color: #555;
            background: white;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
        }
        
        .form-group select,
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.95rem;
        }
        
        .generate-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            padding: 15px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        
        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.4);
        }
        
        .quote-output {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .placeholder-text {
            text-align: center;
            color: #7f8c8d;
        }
        
        .placeholder-text .icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .placeholder-text h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .quote-result {
            display: none;
        }
        
        .quote-result.show {
            display: block;
        }
        
        .quote-header {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .quote-header h2 {
            color: #27ae60;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }
        
        .quote-breakdown {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }
        
        .quote-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .quote-item:last-child {
            border-bottom: none;
        }
        
        .quote-total {
            font-size: 1.4rem;
            font-weight: bold;
            color: #27ae60;
            border-top: 3px solid #27ae60;
            padding-top: 15px;
            margin-top: 15px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>âš¡ Bolt Quotes - Quote Generator</h1>
        <p>Generate professional quotes with uploaded photos</p>
    </div>

    <div class="container">
        <div class="project-selector">
            <label>Select Project:</label>
            <select id="projectSelect" onchange="loadProjectDetails()">
                <option value="">Loading projects...</option>
            </select>
            <button class="refresh-btn" onclick="loadProjects()">ðŸ”„ Refresh</button>
        </div>

        <div class="main-grid" id="mainContent" style="display: none;">
            <!-- LEFT COLUMN -->
            <div class="left-column">
                <!-- Customer Information -->
                <div class="section">
                    <div class="section-title">Customer Information</div>
                    <div class="info-row">
                        <span class="info-label">Name:</span>
                        <span class="info-value" id="customerName">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Email:</span>
                        <span class="info-value" id="customerEmail">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Phone:</span>
                        <span class="info-value" id="customerPhone">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Address:</span>
                        <span class="info-value" id="customerAddress">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Status:</span>
                        <span class="info-value">
                            <select id="statusSelect" class="status-select" onchange="updateProjectStatus()">
                                <option value="Pending Photos">Pending</option>
                                <option value="Photos Uploaded">Photos Uploaded</option>
                                <option value="Quote Ready">Quote Ready</option>
                                <option value="Quoted">Quoted</option>
                                <option value="Accepted">Accepted</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Quote ID:</span>
                        <span class="info-value" id="quoteId" style="color: #667eea; font-weight: 700;">-</span>
                    </div>
                </div>

                <!-- Uploaded Photos -->
                <div class="section">
                    <div class="section-title">Uploaded Photos</div>
                    <div class="photos-grid" id="photosGrid">
                        <div class="loading">No photos available</div>
                    </div>
                </div>

                <!-- Property Information -->
                <div class="section">
                    <div class="section-title">Property Information</div>
                    <div class="form-group">
                        <label>Property Type:</label>
                        <select id="propertyType">
                            <option value="single-family">Single-family home</option>
                            <option value="townhouse">Townhouse</option>
                            <option value="condo">Condo/Apartment</option>
                            <option value="multi-family">Multi-family</option>
                            <option value="commercial">Commercial</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>State:</label>
                        <select id="state">
                            <option value="GA">Georgia</option>
                            <option value="FL">Florida</option>
                            <option value="AL">Alabama</option>
                            <option value="SC">South Carolina</option>
                            <option value="NC">North Carolina</option>
                            <option value="TN">Tennessee</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Distance from Panel to Charger Location (feet):</label>
                        <input type="number" id="distance" value="20" min="0">
                    </div>
                    <div class="form-group">
                        <label>Installation Location:</label>
                        <select id="installLocation">
                            <option value="garage-attached">Attached Garage</option>
                            <option value="garage-detached">Detached Garage</option>
                            <option value="driveway">Driveway</option>
                            <option value="carport">Carport</option>
                            <option value="exterior-wall">Exterior Wall</option>
                        </select>
                    </div>
                </div>

                <!-- Electrical Panel Assessment -->
                <div class="section">
                    <div class="section-title">Electrical Panel Assessment</div>
                    <div class="form-group">
                        <label>Panel Age:</label>
                        <select id="panelAge">
                            <option value="new">Less than 10 years</option>
                            <option value="moderate">10-20 years</option>
                            <option value="old">20+ years</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Available Panel Capacity (Amps):</label>
                        <select id="panelCapacity">
                            <option value="100">100A</option>
                            <option value="125">125A</option>
                            <option value="150">150A</option>
                            <option value="200">200A</option>
                            <option value="400">400A</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Available Breaker Slots:</label>
                        <select id="availableSlots">
                            <option value="0">No available slots</option>
                            <option value="1">1-2 slots</option>
                            <option value="3">3-4 slots</option>
                            <option value="5">5+ slots</option>
                        </select>
                    </div>
                </div>

                <!-- Installation Conditions -->
                <div class="section">
                    <div class="section-title">Installation Conditions</div>
                    <div class="form-group">
                        <label>Conduit Run Type:</label>
                        <select id="conduitType">
                            <option value="surface">Surface mount (easiest)</option>
                            <option value="concealed">Concealed/in-wall</option>
                            <option value="underground">Underground</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ground Charger Type:</label>
                        <select id="chargerType">
                            <option value="standard">Standard hardwired</option>
                            <option value="nema">NEMA outlet</option>
                            <option value="smart">Smart/WiFi enabled</option>
                        </select>
                    </div>
                </div>

                <!-- Business Settings -->
                <div class="section">
                    <div class="section-title">Business Settings</div>
                    <div class="form-group">
                        <label>Markup Percentage:</label>
                        <select id="markup">
                            <option value="25">25% - Standard</option>
                            <option value="30">30%</option>
                            <option value="35">35%</option>
                            <option value="40">40%</option>
                            <option value="45">45% - Premium</option>
                        </select>
                    </div>
                    <button class="generate-btn" onclick="generateQuote()">Generate Professional Quote</button>
                </div>
            </div>

            <!-- RIGHT COLUMN -->
            <div class="quote-output">
                <div class="placeholder-text" id="placeholderText">
                    <div class="icon">ðŸ“‹</div>
                    <h3>Fill out the assessment form</h3>
                    <p>Your professional quote will appear here shortly</p>
                </div>
                <div class="quote-result" id="quoteResult">
                    <div class="quote-header">
                        <h2>Professional Quote</h2>
                    </div>
                    <div class="quote-breakdown" id="quoteBreakdown">
                        <!-- Quote details will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentProject = null;
        let currentQuote = null;
        
        // Load projects on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadProjects();
        });
        
        // Load all projects
        async function loadProjects() {
            const select = document.getElementById('projectSelect');
            select.innerHTML = '<option value="">Loading projects...</option>';
            
            try {
                const response = await fetch('/api/get-projects');
                
                if (!response.ok) {
                    throw new Error('Failed to load projects');
                }
                
                const data = await response.json();
                
                select.innerHTML = '<option value="">-- Select a Project --</option>';
                
                data.records.forEach(record => {
                    const fields = record.fields;
                    const option = document.createElement('option');
                    option.value = record.id;
                    option.textContent = `${fields['Customer Name'] || 'Unnamed'} - ${fields['Property Address'] || 'No Address'}`;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading projects:', error);
                select.innerHTML = '<option value="">Error loading projects</option>';
            }
        }
        
        // Load project details
        async function loadProjectDetails() {
            const projectId = document.getElementById('projectSelect').value;
            
            if (!projectId) {
                document.getElementById('mainContent').style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`/api/get-project?projectId=${projectId}`);
                
                if (!response.ok) {
                    throw new Error('Failed to load project');
                }
                
                currentProject = await response.json();
                console.log('Current project:', currentProject);
                
                displayProjectInfo();
                await loadPhotos();
                
                // Load quote (non-blocking - don't fail if this errors)
                getOrCreateQuote(projectId).catch(err => {
                    console.error('Quote creation failed, but continuing:', err);
                    document.getElementById('quoteId').textContent = 'Error loading';
                });
                
                document.getElementById('mainContent').style.display = 'grid';
                
            } catch (error) {
                console.error('Error loading project:', error);
                alert('Failed to load project details');
            }
        }
        
        // Get or create quote for this project
        async function getOrCreateQuote(projectId) {
            try {
                console.log('Getting or creating quote for project:', projectId);
                
                const response = await fetch('/api/get-or-create-quote', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ projectId })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Quote API error:', response.status, errorText);
                    throw new Error(`Failed to get or create quote: ${response.status}`);
                }
                
                const data = await response.json();
                currentQuote = data.quote;
                
                if (data.created) {
                    console.log('âœ… Created new quote:', currentQuote.fields['Quote ID']);
                } else {
                    console.log('ðŸ“‹ Found existing quote:', currentQuote.fields['Quote ID']);
                }
                
                // Display Quote ID
                document.getElementById('quoteId').textContent = currentQuote.fields['Quote ID'] || 'Generating...';
                
            } catch (error) {
                console.error('Error getting/creating quote:', error);
                document.getElementById('quoteId').textContent = 'Error - See console';
                throw error; // Re-throw so the catch in loadProjectDetails can handle it
            }
        }
        
        // Display project info
        function displayProjectInfo() {
            const fields = currentProject.fields;
            
            document.getElementById('customerName').textContent = fields['Customer Name'] || 'N/A';
            document.getElementById('customerEmail').textContent = fields['Customer Email'] || 'N/A';
            document.getElementById('customerPhone').textContent = fields['Customer Phone'] || 'N/A';
            document.getElementById('customerAddress').textContent = fields['Property Address'] || 'N/A';
            
            // Set status
            const statusSelect = document.getElementById('statusSelect');
            statusSelect.value = fields['Project Status'] || 'Pending Photos';
            
            // Pre-fill form fields
            if (fields['Property Type']) {
                const typeMap = {
                    'single family': 'single-family',
                    'single-family': 'single-family',
                    'townhouse': 'townhouse',
                    'condo': 'condo',
                    'commercial': 'commercial'
                };
                const mapped = typeMap[fields['Property Type'].toLowerCase()];
                if (mapped) document.getElementById('propertyType').value = mapped;
            }
            
            // Set Installation Location from project data
            if (fields['Install Location']) {
                const locMap = {
                    'garage': 'garage-attached',
                    'attached garage': 'garage-attached',
                    'detached garage': 'garage-detached',
                    'driveway': 'driveway',
                    'carport': 'carport',
                    'exterior wall': 'exterior-wall'
                };
                const mapped = locMap[fields['Install Location'].toLowerCase()];
                if (mapped) document.getElementById('installLocation').value = mapped;
            }
            
            // Extract state from address
            if (fields['Property Address']) {
                const stateMatch = fields['Property Address'].match(/\b(AL|AZ|CA|CO|FL|GA|IL|MA|NY|TX|SC|NC|TN)\b/i);
                if (stateMatch) document.getElementById('state').value = stateMatch[0].toUpperCase();
            }
        }
        
        // Load photos - FIXED VERSION
        async function loadPhotos() {
            const photosGrid = document.getElementById('photosGrid');
            photosGrid.innerHTML = '<div class="loading">Loading photos...</div>';

            try {
                console.log('Loading photos for project:', currentProject.id);
                
                const response = await fetch(`/api/get-photos?projectId=${currentProject.id}`);
    
                if (!response.ok) {
                    throw new Error(`Failed to load photos: ${response.status}`);
                }
    
                const data = await response.json();
                console.log('Photos API response:', data);
    
                // Check if we have records
                if (!data.records || data.records.length === 0) {
                    photosGrid.innerHTML = '<div class="loading">No photos available for this project</div>';
                    return;
                }
    
                let hasPhotos = false;
                photosGrid.innerHTML = '';
    
                data.records.forEach((photo, index) => {
                    const fields = photo.fields;
                    console.log(`Photo ${index} fields:`, fields);
        
                    // Check for various possible attachment field names
                    const attachmentField = fields.File || fields.Files || fields.Photo || fields.Photos || 
                                          fields.Attachment || fields.Attachments || fields.Image || fields.Images;
        
                    if (attachmentField && attachmentField.length > 0) {
                        hasPhotos = true;
                        const file = attachmentField[0];
                        
                        // Get the best available URL
                        const photoUrl = file.url || 
                                       (file.thumbnails && file.thumbnails.large && file.thumbnails.large.url) || 
                                       (file.thumbnails && file.thumbnails.small && file.thumbnails.small.url);
                        
                        const photoType = fields['Photo Type'] || fields.Type || fields.Description || 
                                        fields.Label || fields.Name || 'Project Photo';
            
                        if (photoUrl) {
                            const photoCard = document.createElement('div');
                            photoCard.className = 'photo-card';
                            photoCard.innerHTML = `
                                <img src="${photoUrl}" 
                                     alt="${photoType}" 
                                     onerror="this.parentElement.innerHTML='<div style=\\'padding:20px; text-align:center; color:#999;\\'>Image failed to load</div>';">
                                <div class="photo-label">${photoType}</div>
                            `;
                            photosGrid.appendChild(photoCard);
                        }
                    }
                });
    
                if (!hasPhotos) {
                    photosGrid.innerHTML = '<div class="loading">No photos found in project records</div>';
                }
    
            } catch (error) {
                console.error('Error loading photos:', error);
                photosGrid.innerHTML = `<div class="loading">Error loading photos: ${error.message}</div>`;
            }
        }
        
        // Update project status
        async function updateProjectStatus() {
            const newStatus = document.getElementById('statusSelect').value;
            
            if (!confirm(`Change status to "${newStatus}"?`)) {
                document.getElementById('statusSelect').value = currentProject.fields['Project Status'];
                return;
            }
            
            try {
                const response = await fetch('/api/update-project-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        projectId: currentProject.id,
                        status: newStatus
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to update status');
                }
                
                currentProject.fields['Project Status'] = newStatus;
                alert('Status updated successfully!');
                
            } catch (error) {
                console.error('Error updating status:', error);
                alert('Failed to update status');
                document.getElementById('statusSelect').value = currentProject.fields['Project Status'];
            }
        }
        
        // Generate quote
        function generateQuote() {
            // Get all form values
            const propertyType = document.getElementById('propertyType').value;
            const state = document.getElementById('state').value;
            const distance = parseInt(document.getElementById('distance').value) || 20;
            const installLocation = document.getElementById('installLocation').value;
            const panelAge = document.getElementById('panelAge').value;
            const panelCapacity = parseInt(document.getElementById('panelCapacity').value);
            const availableSlots = parseInt(document.getElementById('availableSlots').value);
            const conduitType = document.getElementById('conduitType').value;
            const chargerType = document.getElementById('chargerType').value;
            const markup = parseInt(document.getElementById('markup').value);
            
            // Base labor cost
            let laborCost = 800;
            
            // Property type multiplier
            const propertyMultipliers = {
                'single-family': 1.0,
                'townhouse': 1.1,
                'condo': 1.15,
                'multi-family': 1.2,
                'commercial': 1.5
            };
            laborCost *= propertyMultipliers[propertyType] || 1.0;
            
            // State multiplier
            const stateMultipliers = {
                'GA': 1.0,
                'FL': 1.15,
                'AL': 0.95,
                'SC': 1.0,
                'NC': 1.05,
                'TN': 0.98
            };
            laborCost *= stateMultipliers[state] || 1.0;
            
            // Distance cost (conduit + wiring)
            let distanceCost = 0;
            if (distance > 20) {
                const extraFeet = distance - 20;
                distanceCost = extraFeet * 12; // $12 per foot
            }
            
            // Conduit type adjustment
            const conduitMultipliers = {
                'surface': 1.0,
                'concealed': 1.3,
                'underground': 1.5
            };
            distanceCost *= conduitMultipliers[conduitType] || 1.0;
            
            // Materials cost
            let materialsCost = 350;
            
            // Charger type cost
            const chargerCosts = {
                'standard': 0,
                'nema': 50,
                'smart': 150
            };
            materialsCost += chargerCosts[chargerType] || 0;
            
            // Panel upgrade assessment
            let panelUpgradeCost = 0;
            if (panelCapacity < 200 || availableSlots === 0) {
                panelUpgradeCost = 2500;
            }
            
            // Permit costs by state
            const permitCosts = {
                'GA': 150,
                'FL': 200,
                'AL': 125,
                'SC': 140,
                'NC': 175,
                'TN': 145
            };
            const permitCost = permitCosts[state] || 150;
            
            // Calculate subtotal
            const subtotal = laborCost + distanceCost + materialsCost + panelUpgradeCost;
            
            // Apply markup
            const markupAmount = subtotal * (markup / 100);
            
            // Calculate total
            const total = subtotal + markupAmount + permitCost;
            
            // Display quote
            document.getElementById('placeholderText').style.display = 'none';
            document.getElementById('quoteResult').classList.add('show');
            
            const breakdownDiv = document.getElementById('quoteBreakdown');
            breakdownDiv.innerHTML = `
                <div class="quote-item">
                    <span>Labor (${propertyType}, ${state}):</span>
                    <span>$${laborCost.toFixed(2)}</span>
                </div>
                <div class="quote-item">
                    <span>Materials & Equipment:</span>
                    <span>$${materialsCost.toFixed(2)}</span>
                </div>
                <div class="quote-item">
                    <span>Conduit & Wiring (${distance}ft, ${conduitType}):</span>
                    <span>$${distanceCost.toFixed(2)}</span>
                </div>
                ${panelUpgradeCost > 0 ? `<div class="quote-item"><span>Panel Upgrade Required:</span><span>$${panelUpgradeCost.toFixed(2)}</span></div>` : ''}
                <div class="quote-item">
                    <span>Business Markup (${markup}%):</span>
                    <span>$${markupAmount.toFixed(2)}</span>
                </div>
                <div class="quote-item">
                    <span>Permit & Inspection (${state}):</span>
                    <span>$${permitCost.toFixed(2)}</span>
                </div>
                <div class="quote-item quote-total">
                    <span>Total Quote:</span>
                    <span>$${total.toFixed(2)}</span>
                </div>
            `;
        }
    </script>
</body>
</html>
