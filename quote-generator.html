<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bolt Quotes - Quote Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
            border-radius: 15px 15px 0 0;
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
        }
        
        .main-content {
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .left-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .right-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }
        
        .section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .project-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .project-selector label {
            font-weight: 600;
            color: #2c3e50;
            white-space: nowrap;
        }
        
        .project-selector select {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .refresh-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            white-space: nowrap;
        }
        
        .refresh-btn:hover {
            background: #2980b9;
        }
        
        .info-row {
            display: flex;
            padding: 12px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 600;
            color: #2c3e50;
            min-width: 160px;
        }
        
        .info-value {
            color: #495057;
            flex: 1;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-uploaded {
            background: #d4edda;
            color: #155724;
        }
        
        .status-dropdown {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.95rem;
            cursor: pointer;
        }
        
        .photos-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .photo-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .photo-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }
        
        .photo-label {
            padding: 12px;
            text-align: center;
            font-weight: 600;
            color: #2c3e50;
            background: #f8f9fa;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .generate-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }
        
        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
        }
        
        .quote-result {
            grid-column: 1 / -1;
            background: #ecf0f1;
            padding: 30px;
            border-radius: 10px;
            display: none;
        }
        
        .quote-result h2 {
            color: #27ae60;
            font-size: 2rem;
            margin-bottom: 20px;
        }
        
        .quote-breakdown {
            background: white;
            padding: 25px;
            border-radius: 8px;
        }
        
        .quote-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .quote-item:last-child {
            border-bottom: none;
        }
        
        .quote-total {
            font-size: 1.5rem;
            font-weight: bold;
            color: #27ae60;
            border-top: 3px solid #27ae60;
            padding-top: 15px;
            margin-top: 15px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .photos-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš¡ Bolt Quotes - Quote Generator</h1>
            <p>Generate professional quotes with uploaded photos</p>
        </div>

        <div style="padding: 30px;">
            <div class="project-selector">
                <label>Select Project:</label>
                <select id="projectSelect" onchange="loadProjectDetails()">
                    <option value="">Loading projects...</option>
                </select>
                <button class="refresh-btn" onclick="loadProjects()">ðŸ”„ Refresh</button>
            </div>
        </div>

        <div class="main-content" id="mainContent" style="display: none;">
            <!-- LEFT COLUMN -->
            <div class="left-column">
                <!-- Customer Information -->
                <div class="section">
                    <h3>ðŸ‘¤ Customer Information</h3>
                    <div class="info-row">
                        <span class="info-label">Customer Name:</span>
                        <span class="info-value" id="customerName">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Email:</span>
                        <span class="info-value" id="customerEmail">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Phone:</span>
                        <span class="info-value" id="customerPhone">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Property Address:</span>
                        <span class="info-value" id="propertyAddress">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Property Type:</span>
                        <span class="info-value" id="propertyType">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Install Location:</span>
                        <span class="info-value" id="installLocation">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">EV Model:</span>
                        <span class="info-value" id="evModel">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Status:</span>
                        <span class="info-value">
                            <select id="statusDropdown" class="status-dropdown" onchange="updateProjectStatus()">
                                <option value="Pending Photos">Pending Photos</option>
                                <option value="Photos Uploaded">Photos Uploaded</option>
                                <option value="Quote Ready">Quote Ready</option>
                                <option value="Quoted">Quoted</option>
                                <option value="Accepted">Accepted</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </span>
                    </div>
                </div>

                <!-- Uploaded Photos -->
                <div class="section">
                    <h3>ðŸ“¸ Uploaded Photos</h3>
                    <div class="photos-grid" id="photosGrid">
                        <div class="loading">No photos found</div>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN -->
            <div class="right-column">
                <!-- Quote Calculator -->
                <div class="section">
                    <h3>ðŸ’° Quote Calculator</h3>
                    
                    <div class="form-group">
                        <label>Property Type:</label>
                        <select id="calcPropertyType">
                            <option value="single-family">Single Family Home</option>
                            <option value="townhouse">Townhouse</option>
                            <option value="condo">Condo/Apartment</option>
                            <option value="commercial">Commercial</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Install Location:</label>
                        <select id="calcLocation">
                            <option value="garage-attached">Attached Garage</option>
                            <option value="garage-detached">Detached Garage</option>
                            <option value="driveway">Driveway</option>
                            <option value="exterior-wall">Exterior Wall</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Distance from Panel (feet):</label>
                        <input type="number" id="calcDistance" value="20">
                    </div>
                    
                    <div class="form-group">
                        <label>State:</label>
                        <select id="calcState">
                            <option value="GA">Georgia</option>
                            <option value="FL">Florida</option>
                            <option value="AL">Alabama</option>
                            <option value="SC">South Carolina</option>
                            <option value="NC">North Carolina</option>
                            <option value="TN">Tennessee</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Panel Upgrade Needed:</label>
                        <select id="calcPanelUpgrade">
                            <option value="no">No</option>
                            <option value="yes">Yes</option>
                        </select>
                    </div>
                    
                    <button class="generate-btn" onclick="generateQuote()">âš¡ Generate Quote</button>
                </div>
            </div>

            <!-- Quote Result (full width) -->
            <div class="quote-result" id="quoteResult">
                <h2>ðŸ’µ Quote Summary</h2>
                <div class="quote-breakdown" id="quoteBreakdown">
                    <!-- Quote details will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentProject = null;
        
        // Load projects on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadProjects();
        });
        
        // Load all projects
        async function loadProjects() {
            const select = document.getElementById('projectSelect');
            select.innerHTML = '<option value="">Loading projects...</option>';
            
            try {
                const response = await fetch('/api/get-projects');
                
                if (!response.ok) {
                    throw new Error('Failed to load projects');
                }
                
                const data = await response.json();
                
                select.innerHTML = '<option value="">-- Select a Project --</option>';
                
                data.records.forEach(record => {
                    const fields = record.fields;
                    const option = document.createElement('option');
                    option.value = record.id;
                    option.textContent = `${fields['Customer Name'] || 'Unnamed'} - ${fields['Property Address'] || 'No Address'}`;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading projects:', error);
                select.innerHTML = '<option value="">Error loading projects</option>';
            }
        }
        
        // Load project details
        async function loadProjectDetails() {
            const projectId = document.getElementById('projectSelect').value;
            
            if (!projectId) {
                document.getElementById('mainContent').style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`/api/get-project?projectId=${projectId}`);
                
                if (!response.ok) {
                    throw new Error('Failed to load project');
                }
                
                currentProject = await response.json();
                
                displayProjectInfo();
                loadPhotos();
                
                document.getElementById('mainContent').style.display = 'grid';
                
            } catch (error) {
                console.error('Error loading project:', error);
                alert('Failed to load project details');
            }
        }
        
        // Display project info
        function displayProjectInfo() {
            const fields = currentProject.fields;
            
            document.getElementById('customerName').textContent = fields['Customer Name'] || 'N/A';
            document.getElementById('customerEmail').textContent = fields['Customer Email'] || 'N/A';
            document.getElementById('customerPhone').textContent = fields['Customer Phone'] || 'N/A';
            document.getElementById('propertyAddress').textContent = fields['Property Address'] || 'N/A';
            document.getElementById('propertyType').textContent = fields['Property Type'] || 'N/A';
            document.getElementById('installLocation').textContent = fields['Install Location'] || 'N/A';
            document.getElementById('evModel').textContent = fields['EV Model'] || 'N/A';
            
            // Set status dropdown
            const statusDropdown = document.getElementById('statusDropdown');
            statusDropdown.value = fields['Project Status'] || 'Pending Photos';
            
            // Pre-fill calculator
            if (fields['Property Type']) {
                const typeMap = {
                    'single family': 'single-family',
                    'single-family': 'single-family',
                    'townhouse': 'townhouse',
                    'condo': 'condo',
                    'commercial': 'commercial'
                };
                const mapped = typeMap[fields['Property Type'].toLowerCase()];
                if (mapped) document.getElementById('calcPropertyType').value = mapped;
            }
            
            if (fields['Install Location']) {
                const locMap = {
                    'garage': 'garage-attached',
                    'attached garage': 'garage-attached',
                    'detached garage': 'garage-detached',
                    'driveway': 'driveway',
                    'exterior wall': 'exterior-wall'
                };
                const mapped = locMap[fields['Install Location'].toLowerCase()];
                if (mapped) document.getElementById('calcLocation').value = mapped;
            }
            
            // Extract state
            if (fields['Property Address']) {
                const stateMatch = fields['Property Address'].match(/\b(AL|AZ|CA|CO|FL|GA|IL|MA|NY|TX|SC|NC|TN)\b/i);
                if (stateMatch) document.getElementById('calcState').value = stateMatch[0].toUpperCase();
            }
        }
        
        // Load photos
        async function loadPhotos() {
            const photosGrid = document.getElementById('photosGrid');
            photosGrid.innerHTML = '<div class="loading">Loading photos...</div>';
            
            try {
                const response = await fetch(`/api/get-photos?projectId=${currentProject.id}`);
                
                if (!response.ok) {
                    throw new Error('Failed to load photos');
                }
                
                const data = await response.json();
                
                if (data.records.length === 0) {
                    photosGrid.innerHTML = '<div class="loading">No photos found for this project</div>';
                    return;
                }
                
                photosGrid.innerHTML = '';
                
                data.records.forEach(photo => {
                    const fields = photo.fields;
                    if (fields.File && fields.File.length > 0) {
                        const photoCard = document.createElement('div');
                        photoCard.className = 'photo-card';
                        photoCard.innerHTML = `
                            <img src="${fields.File[0].url}" alt="${fields['Photo Type'] || 'Photo'}">
                            <div class="photo-label">${fields['Photo Type'] || 'Unknown'}</div>
                        `;
                        photosGrid.appendChild(photoCard);
                    }
                });
                
            } catch (error) {
                console.error('Error loading photos:', error);
                photosGrid.innerHTML = '<div class="error">Error loading photos: ' + error.message + '</div>';
            }
        }
        
        // Update project status
        async function updateProjectStatus() {
            const newStatus = document.getElementById('statusDropdown').value;
            
            if (!confirm(`Change status to "${newStatus}"?`)) {
                document.getElementById('statusDropdown').value = currentProject.fields['Project Status'];
                return;
            }
            
            try {
                const response = await fetch('/api/update-project-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        projectId: currentProject.id,
                        status: newStatus
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to update status');
                }
                
                currentProject.fields['Project Status'] = newStatus;
                alert('Status updated successfully!');
                
            } catch (error) {
                console.error('Error updating status:', error);
                alert('Failed to update status');
                document.getElementById('statusDropdown').value = currentProject.fields['Project Status'];
            }
        }
        
        // Generate quote
        function generateQuote() {
            const propertyType = document.getElementById('calcPropertyType').value;
            const location = document.getElementById('calcLocation').value;
            const distance = parseInt(document.getElementById('calcDistance').value) || 20;
            const state = document.getElementById('calcState').value;
            const panelUpgrade = document.getElementById('calcPanelUpgrade').value;
            
            // Base pricing
            let basePrice = 1200;
            
            // Property type adjustment
            const propertyMultipliers = {
                'single-family': 1.0,
                'townhouse': 1.1,
                'condo': 1.2,
                'commercial': 1.5
            };
            basePrice *= propertyMultipliers[propertyType] || 1.0;
            
            // Location adjustment
            const locationCosts = {
                'garage-attached': 0,
                'garage-detached': 200,
                'driveway': 300,
                'exterior-wall': 250
            };
            const locationCost = locationCosts[location] || 0;
            
            // Distance cost
            const distanceCost = Math.max(0, distance - 20) * 15;
            
            // State permit cost
            const permitCosts = {
                'GA': 150,
                'FL': 175,
                'AL': 125,
                'SC': 140,
                'NC': 160,
                'TN': 145
            };
            const permitCost = permitCosts[state] || 150;
            
            // Panel upgrade
            const panelUpgradeCost = panelUpgrade === 'yes' ? 2500 : 0;
            
            // Materials
            const materialsCost = 400;
            
            // Calculate total
            const subtotal = basePrice + locationCost + distanceCost + materialsCost + panelUpgradeCost;
            const total = subtotal + permitCost;
            
            // Display result
            const breakdownDiv = document.getElementById('quoteBreakdown');
            breakdownDiv.innerHTML = `
                <div class="quote-item">
                    <span>Base Installation:</span>
                    <span>$${basePrice.toFixed(2)}</span>
                </div>
                <div class="quote-item">
                    <span>Location Premium:</span>
                    <span>$${locationCost.toFixed(2)}</span>
                </div>
                <div class="quote-item">
                    <span>Distance Charge (${distance}ft):</span>
                    <span>$${distanceCost.toFixed(2)}</span>
                </div>
                <div class="quote-item">
                    <span>Materials & Hardware:</span>
                    <span>$${materialsCost.toFixed(2)}</span>
                </div>
                ${panelUpgradeCost > 0 ? `<div class="quote-item"><span>Panel Upgrade:</span><span>$${panelUpgradeCost.toFixed(2)}</span></div>` : ''}
                <div class="quote-item">
                    <span>Permit (${state}):</span>
                    <span>$${permitCost.toFixed(2)}</span>
                </div>
                <div class="quote-item quote-total">
                    <span>Total:</span>
                    <span>$${total.toFixed(2)}</span>
                </div>
            `;
            
            document.getElementById('quoteResult').style.display = 'block';
            document.getElementById('quoteResult').scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>
