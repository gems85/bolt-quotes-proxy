<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bolt Quotes - Quote Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #2532eb 0%, #2532eb 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .header p {
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .form-row label {
            font-weight: 600;
            min-width: 120px;
            color: #2c3e50;
        }
        
        .form-row select,
        .form-row input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .refresh-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin-left: 10px;
        }
        
        .refresh-btn:hover {
            background: #2980b9;
        }
        
        .customer-info p {
            margin: 10px 0;
            font-size: 1rem;
        }
        
        .customer-info strong {
            color: #2c3e50;
            min-width: 150px;
            display: inline-block;
        }
        
        .photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .photo-item {
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .photo-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .photo-item p {
            text-align: center;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .calculate-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }
        
        .calculate-btn:hover {
            background: #229954;
        }
        
        .quote-result {
            background: #ecf0f1;
            padding: 30px;
            border-radius: 10px;
            margin-top: 30px;
            display: none;
        }
        
        .quote-result h2 {
            color: #27ae60;
            font-size: 2rem;
            margin-bottom: 20px;
        }
        
        .quote-breakdown {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .quote-breakdown p {
            margin: 10px 0;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
        }
        
        .quote-breakdown .total {
            font-size: 1.5rem;
            font-weight: bold;
            color: #27ae60;
            border-top: 2px solid #27ae60;
            padding-top: 15px;
            margin-top: 15px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš¡ Bolt Quotes - Quote Generator</h1>
            <p>Generate professional quotes with uploaded photos</p>
        </div>
        
        <div class="content">
            <!-- Project Selection -->
            <div class="section">
                <div class="form-row">
                    <label for="projectSelect">Select Project:</label>
                    <select id="projectSelect" onchange="loadProjectDetails()">
                        <option value="">Loading projects...</option>
                    </select>
                    <button class="refresh-btn" onclick="loadProjects()">ðŸ”„ Refresh</button>
                </div>
            </div>
            
            <!-- Customer Information -->
            <div class="section" id="customerSection" style="display: none;">
                <div id="customerInfo" class="customer-info">
                    <div class="loading">Select a project to view details...</div>
                </div>
            </div>
            
            <!-- Uploaded Photos -->
            <div class="section" id="photosSection" style="display: none;">
                <h3>ðŸ“¸ Uploaded Photos</h3>
                <div id="photosGrid" class="photos-grid">
                    <div class="loading">No photos found for this project</div>
                </div>
            </div>
            
            <!-- Quote Calculator -->
            <div class="section" id="calculatorSection" style="display: none;">
                <h3>ðŸ’° Quote Calculator</h3>
                
                <div class="form-row">
                    <label for="propertyType">Property Type:</label>
                    <select id="propertyType">
                        <option value="single-family">Single Family Home</option>
                        <option value="townhouse">Townhouse</option>
                        <option value="condo">Condo/Apartment</option>
                        <option value="commercial">Commercial</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <label for="location">Install Location:</label>
                    <select id="location">
                        <option value="garage-attached">Attached Garage</option>
                        <option value="garage-detached">Detached Garage</option>
                        <option value="driveway">Driveway</option>
                        <option value="exterior-wall">Exterior Wall</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <label for="distance">Distance from Panel:</label>
                    <input type="number" id="distance" placeholder="Distance in feet" value="20">
                </div>
                
                <div class="form-row">
                    <label for="state">State:</label>
                    <select id="state">
                        <option value="GA">Georgia</option>
                        <option value="FL">Florida</option>
                        <option value="AL">Alabama</option>
                        <option value="SC">South Carolina</option>
                        <option value="NC">North Carolina</option>
                        <option value="TN">Tennessee</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <label for="panelUpgrade">Panel Upgrade Needed:</label>
                    <select id="panelUpgrade">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
                
                <button class="calculate-btn" onclick="generateQuote()">âš¡ Generate Quote</button>
            </div>
            
            <!-- Quote Result -->
            <div class="quote-result" id="quoteResult">
                <h2>Quote Summary</h2>
                <div class="quote-breakdown" id="quoteBreakdown">
                    <!-- Quote details will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentProject = null;
        
        // Load projects on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadProjects();
        });
        
        // Load all projects using secure API route
        async function loadProjects() {
            const select = document.getElementById('projectSelect');
            select.innerHTML = '<option value="">Loading projects...</option>';
            
            try {
                console.log('Fetching projects from API...');
                
                const response = await fetch('/api/get-projects');
                
                console.log('API response status:', response.status);
                
                if (!response.ok) {
                    const error = await response.json();
                    console.error('API error:', error);
                    throw new Error(error.message || 'Failed to load projects');
                }
                
                const data = await response.json();
                console.log('Projects loaded:', data.records.length);
                
                select.innerHTML = '<option value="">-- Select a Project --</option>';
                
                data.records.forEach(record => {
                    const fields = record.fields;
                    const option = document.createElement('option');
                    option.value = record.id;
                    option.textContent = `${fields['Customer Name'] || 'Unnamed'} - ${fields['Property Address'] || 'No Address'} (${fields['Project Status'] || 'Pending'})`;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading projects:', error);
                select.innerHTML = '<option value="">Error loading projects</option>';
                alert('Failed to load projects: ' + error.message);
            }
        }
        
        // Load project details using secure API route
        async function loadProjectDetails() {
            const select = document.getElementById('projectSelect');
            const projectId = select.value;
            
            if (!projectId) {
                document.getElementById('customerSection').style.display = 'none';
                document.getElementById('photosSection').style.display = 'none';
                document.getElementById('calculatorSection').style.display = 'none';
                document.getElementById('quoteResult').style.display = 'none';
                return;
            }
            
            try {
                console.log('Loading project:', projectId);
                
                const response = await fetch(`/api/get-project?projectId=${projectId}`);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to load project details');
                }
                
                currentProject = await response.json();
                console.log('Project loaded:', currentProject);
                console.log('Project status:', currentProject.fields['Project Status']);
                
                displayCustomerInfo();
                loadPhotos();
                
                document.getElementById('customerSection').style.display = 'block';
                document.getElementById('photosSection').style.display = 'block';
                document.getElementById('calculatorSection').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading project:', error);
                alert('Failed to load project details: ' + error.message);
            }
        }
        
        // Display customer info
        function displayCustomerInfo() {
            const fields = currentProject.fields;
            const infoDiv = document.getElementById('customerInfo');
            
            infoDiv.innerHTML = `
                <h3>Property Information</h3>
                <p><strong>Customer Name:</strong> ${fields['Customer Name'] || 'N/A'}</p>
                <p><strong>Email:</strong> ${fields['Customer Email'] || 'N/A'}</p>
                <p><strong>Phone:</strong> ${fields['Customer Phone'] || 'N/A'}</p>
                <p><strong>Property Address:</strong> ${fields['Property Address'] || 'N/A'}</p>
                <p><strong>Property Type:</strong> ${fields['Property Type'] || 'N/A'}</p>
                <p><strong>Install Location:</strong> ${fields['Install Location'] || 'N/A'}</p>
                <p><strong>EV Model:</strong> ${fields['EV Model'] || 'N/A'}</p>
                <p><strong>Project Status:</strong> <span style="color: ${fields['Project Status'] === 'Photos Uploaded' ? '#27ae60' : '#f39c12'}; font-weight: bold;">${fields['Project Status'] || 'Pending'}</span></p>
            `;
            
            // Pre-fill form fields if available
            if (fields['Property Type']) {
                const propertyTypeMap = {
                    'single family': 'single-family',
                    'single-family': 'single-family',
                    'townhouse': 'townhouse',
                    'condo': 'condo',
                    'condominium': 'condo',
                    'commercial': 'commercial'
                };
                const mappedType = propertyTypeMap[fields['Property Type'].toLowerCase()];
                if (mappedType) {
                    document.getElementById('propertyType').value = mappedType;
                }
            }
            
            if (fields['Install Location']) {
                const locationMap = {
                    'garage': 'garage-attached',
                    'attached garage': 'garage-attached',
                    'detached garage': 'garage-detached',
                    'driveway': 'driveway',
                    'exterior wall': 'exterior-wall'
                };
                const mappedLocation = locationMap[fields['Install Location'].toLowerCase()];
                if (mappedLocation) {
                    document.getElementById('location').value = mappedLocation;
                }
            }
            
            // Extract state from address
            if (fields['Property Address']) {
                const address = fields['Property Address'];
                const stateMatch = address.match(/\b(AL|AZ|CA|CO|FL|GA|IL|MA|NY|TX|SC|NC|TN)\b/i);
                if (stateMatch) {
                    document.getElementById('state').value = stateMatch[0].toUpperCase();
                }
            }
        }
        
        // Load photos using secure API route
        async function loadPhotos() {
            try {
                console.log('Loading photos for project:', currentProject.id);
                
                const response = await fetch(`/api/get-photos?projectId=${currentProject.id}`);
                
                if (!response.ok) {
                    const error = await response.json();
                    console.error('Photos fetch failed:', error);
                    throw new Error(error.message || 'Failed to load photos');
                }
                
                const data = await response.json();
                console.log('Photos found:', data.records.length);
                
                const photosGrid = document.getElementById('photosGrid');
                
                if (data.records.length === 0) {
                    photosGrid.innerHTML = '<div class="loading">No photos found for this project</div>';
                    return;
                }
                
                photosGrid.innerHTML = '';
                
                data.records.forEach(photo => {
                    const fields = photo.fields;
                    if (fields.File && fields.File.length > 0) {
                        const photoDiv = document.createElement('div');
                        photoDiv.className = 'photo-item';
                        photoDiv.innerHTML = `
                            <img src="${fields.File[0].url}" alt="${fields['Photo Type'] || 'Photo'}">
                            <p>${fields['Photo Type'] || 'Unknown'}</p>
                        `;
                        photosGrid.appendChild(photoDiv);
                    }
                });
                
            } catch (error) {
                console.error('Error loading photos:', error);
                document.getElementById('photosGrid').innerHTML = 
                    '<div class="loading">Error loading photos: ' + error.message + '</div>';
            }
        }
        
        // Generate quote
        function generateQuote() {
            const propertyType = document.getElementById('propertyType').value;
            const location = document.getElementById('location').value;
            const distance = parseInt(document.getElementById('distance').value) || 20;
            const state = document.getElementById('state').value;
            const panelUpgrade = document.getElementById('panelUpgrade').value;
            
            // Base pricing
            let basePrice = 1200;
            
            // Property type adjustment
            const propertyMultipliers = {
                'single-family': 1.0,
                'townhouse': 1.1,
                'condo': 1.2,
                'commercial': 1.5
            };
            basePrice *= propertyMultipliers[propertyType] || 1.0;
            
            // Location adjustment
            const locationCosts = {
                'garage-attached': 0,
                'garage-detached': 200,
                'driveway': 300,
                'exterior-wall': 250
            };
            const locationCost = locationCosts[location] || 0;
            
            // Distance cost (conduit + wiring)
            const distanceCost = Math.max(0, distance - 20) * 15;
            
            // State permit cost
            const permitCosts = {
                'GA': 150,
                'FL': 175,
                'AL': 125,
                'SC': 140,
                'NC': 160,
                'TN': 145
            };
            const permitCost = permitCosts[state] || 150;
            
            // Panel upgrade
            const panelUpgradeCost = panelUpgrade === 'yes' ? 2500 : 0;
            
            // Materials
            const materialsCost = 400;
            
            // Calculate total
            const subtotal = basePrice + locationCost + distanceCost + materialsCost + panelUpgradeCost;
            const total = subtotal + permitCost;
            
            // Display result
            const breakdownDiv = document.getElementById('quoteBreakdown');
            breakdownDiv.innerHTML = `
                <p><span>Base Installation:</span><span>$${basePrice.toFixed(2)}</span></p>
                <p><span>Location Premium:</span><span>$${locationCost.toFixed(2)}</span></p>
                <p><span>Distance Charge (${distance}ft):</span><span>$${distanceCost.toFixed(2)}</span></p>
                <p><span>Materials & Hardware:</span><span>$${materialsCost.toFixed(2)}</span></p>
                ${panelUpgradeCost > 0 ? `<p><span>Panel Upgrade:</span><span>$${panelUpgradeCost.toFixed(2)}</span></p>` : ''}
                <p><span>Permit (${state}):</span><span>$${permitCost.toFixed(2)}</span></p>
                <p class="total"><span>Total:</span><span>$${total.toFixed(2)}</span></p>
            `;
            
            document.getElementById('quoteResult').style.display = 'block';
            document.getElementById('quoteResult').scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>
